import { render, RenderOptions } from '@testing-library/react'
import { ReactElement } from 'react'
import { BrowserRouter } from 'react-router-dom'
import { AuthProvider } from '../contexts/AuthContext'
import { NavigationProvider } from '../contexts/NavigationContext'
import { vi } from 'vitest'

/**
 * è‡ªè¨‚æ¸²æŸ“å‡½æ•¸ï¼ŒåŒ…å«å¿…è¦çš„ Provider
 */
const AllProviders = ({ children }: { children: React.ReactNode }) => {
  return (
    <BrowserRouter>
      <AuthProvider>
        <NavigationProvider>
          {children}
        </NavigationProvider>
      </AuthProvider>
    </BrowserRouter>
  )
}

const customRender = (
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>
) => render(ui, { wrapper: AllProviders, ...options })

export * from '@testing-library/react'
export { customRender as render }

/**
 * æ¨¡æ“¬å°Žèˆªå‡½æ•¸
 */
export const mockNavigate = vi.fn()

/**
 * æ¨¡æ“¬ React Router hooks
 */
export const mockUseNavigate = () => mockNavigate
export const mockUseParams = (params: Record<string, string>) => () => params
export const mockUseLocation = (location: Partial<Location>) => () => ({
  pathname: '/',
  search: '',
  hash: '',
  state: null,
  key: 'default',
  ...location
})

/**
 * æ¸…ç†æ‰€æœ‰ mock
 */
export const clearAllMocks = () => {
  vi.clearAllMocks()
  mockNavigate.mockClear()
}

/**
 * ç­‰å¾…éžåŒæ­¥æ“ä½œå®Œæˆ
 */
export const waitForAsync = (ms: number = 0) =>
  new Promise(resolve => setTimeout(resolve, ms))

/**
 * æ¨¡æ“¬ API å»¶é²
 */
export const mockApiDelay = (ms: number = 500) =>
  new Promise(resolve => setTimeout(resolve, ms))

/**
 * æ¨¡æ“¬ API éŒ¯èª¤
 */
export const mockApiError = (message: string, status: number = 500) => {
  const error = new Error(message) as any
  error.status = status
  return Promise.reject(error)
}

/**
 * å‰µå»ºæ¸¬è©¦ç”¨çš„æäº¤è¨˜éŒ„
 */
export const createMockSubmission = (overrides = {}) => ({
  id: 'test_001',
  userId: 'user_001',
  userName: 'æ¸¬è©¦ç”¨æˆ¶',
  userDepartment: 'æ¸¬è©¦éƒ¨é–€',
  categoryId: 'diesel',
  categoryName: 'æŸ´æ²¹',
  scope: 1 as const,
  status: 'submitted' as const,
  submissionDate: '2024-03-15',
  amount: 100,
  unit: 'å…¬å‡',
  co2Emission: 250,
  priority: 'medium' as const,
  ...overrides
})

/**
 * å‰µå»ºæ¸¬è©¦ç”¨çš„ç”¨æˆ¶
 */
export const createMockUser = (overrides = {}) => ({
  id: 'user_001',
  name: 'æ¸¬è©¦ç”¨æˆ¶',
  email: 'test@example.com',
  department: 'æ¸¬è©¦éƒ¨é–€',
  status: 'submitted' as const,
  submissionDate: '2024-03-15',
  lastActivity: '2024-03-20',
  entries: 5,
  avatar: 'ðŸ‘¨â€ðŸ’»',
  ...overrides
})

/**
 * å‰µå»ºæ¸¬è©¦ç”¨çš„èƒ½æºé¡žåˆ¥
 */
export const createMockEnergyCategory = (overrides = {}) => ({
  id: 'diesel',
  name: 'æŸ´æ²¹',
  scope: 1 as const,
  ...overrides
})

/**
 * æ¨¡æ“¬éµç›¤äº‹ä»¶
 */
export const createKeyboardEvent = (key: string, options = {}) => {
  return new KeyboardEvent('keydown', {
    key,
    code: key,
    bubbles: true,
    cancelable: true,
    ...options
  })
}

/**
 * æ¨¡æ“¬æ»‘é¼ äº‹ä»¶
 */
export const createMouseEvent = (type: string, options = {}) => {
  return new MouseEvent(type, {
    bubbles: true,
    cancelable: true,
    ...options
  })
}

/**
 * æª¢æŸ¥å…ƒç´ æ˜¯å¦å¯è¦‹
 */
export const isElementVisible = (element: HTMLElement) => {
  const style = window.getComputedStyle(element)
  return style.display !== 'none' &&
         style.visibility !== 'hidden' &&
         style.opacity !== '0'
}

/**
 * ç­‰å¾…å…ƒç´ å‡ºç¾
 */
export const waitForElement = async (
  querySelector: () => HTMLElement | null,
  timeout: number = 5000
): Promise<HTMLElement> => {
  const start = Date.now()

  return new Promise((resolve, reject) => {
    const check = () => {
      const element = querySelector()
      if (element) {
        resolve(element)
      } else if (Date.now() - start > timeout) {
        reject(new Error('Element not found within timeout'))
      } else {
        setTimeout(check, 100)
      }
    }
    check()
  })
}

/**
 * æ¸¬è©¦éŒ¯èª¤é‚Šç•Œ
 */
export const ThrowError = ({ error }: { error: Error }) => {
  throw error
}

/**
 * æ¨¡æ“¬è¡¨å–®è³‡æ–™
 */
export const createMockFormData = (overrides = {}) => ({
  name: 'æ¸¬è©¦ç”¨æˆ¶',
  email: 'test@example.com',
  password: 'password123',
  company: 'æ¸¬è©¦å…¬å¸',
  department: 'æ¸¬è©¦éƒ¨é–€',
  targetYear: 2024,
  energyCategories: ['diesel', 'electricity_bill'],
  isActive: true,
  ...overrides
})

/**
 * æ¨¡æ“¬æœ¬åœ°å„²å­˜
 */
export const mockLocalStorage = (() => {
  let store: Record<string, string> = {}

  return {
    getItem: vi.fn((key: string) => store[key] || null),
    setItem: vi.fn((key: string, value: string) => {
      store[key] = value.toString()
    }),
    removeItem: vi.fn((key: string) => {
      delete store[key]
    }),
    clear: vi.fn(() => {
      store = {}
    }),
    key: vi.fn((index: number) => {
      const keys = Object.keys(store)
      return keys[index] || null
    }),
    get length() {
      return Object.keys(store).length
    }
  }
})()

// åœ¨æ¸¬è©¦ç’°å¢ƒä¸­æ›¿æ› localStorage
Object.defineProperty(window, 'localStorage', {
  value: mockLocalStorage
})

/**
 * æ¨¡æ“¬ window.confirm
 */
export const mockConfirm = vi.fn()
Object.defineProperty(window, 'confirm', { value: mockConfirm })

/**
 * æ¨¡æ“¬ window.alert
 */
export const mockAlert = vi.fn()
Object.defineProperty(window, 'alert', { value: mockAlert })

/**
 * é‡ç½®æ‰€æœ‰ window mock
 */
export const resetWindowMocks = () => {
  mockConfirm.mockReset()
  mockAlert.mockReset()
}