# èƒ½æºå¡«å ±ç³»çµ±å·¥ä½œæµç¨‹æ–‡ä»¶

## ğŸ“‹ æ–‡ä»¶è³‡è¨Š

- **æ–‡ä»¶ç‰ˆæœ¬**ï¼šv1.0
- **å»ºç«‹æ—¥æœŸ**ï¼š2025-01-01
- **é©ç”¨ç¯„åœ**ï¼š14 å€‹èƒ½æºé¡åˆ¥é é¢
- **ç›¸é—œæ–‡ä»¶**ï¼šREFACTORING_PLAN.md

---

## ğŸ“š ç›®éŒ„

1. [æµç¨‹ç¸½è¦½](#æµç¨‹ç¸½è¦½)
2. [æµç¨‹ 1ï¼šé¦–æ¬¡å¡«å ±](#æµç¨‹-1é¦–æ¬¡å¡«å ±)
3. [æµç¨‹ 2ï¼šé‡æ–°é€²å…¥é é¢](#æµç¨‹-2é‡æ–°é€²å…¥é é¢è¼‰å…¥èˆŠè³‡æ–™)
4. [æµç¨‹ 3ï¼šä¿®æ”¹å·²æäº¤çš„è³‡æ–™](#æµç¨‹-3ä¿®æ”¹å·²æäº¤çš„è³‡æ–™)
5. [æµç¨‹ 4ï¼šç®¡ç†å“¡å¯©æ ¸ - é€€ä»¶](#æµç¨‹-4ç®¡ç†å“¡å¯©æ ¸---é€€ä»¶)
6. [æµç¨‹ 5ï¼šä½¿ç”¨è€…çœ‹åˆ°é€€ä»¶ä¸¦é‡æ–°æäº¤](#æµç¨‹-5ä½¿ç”¨è€…çœ‹åˆ°é€€ä»¶ä¸¦é‡æ–°æäº¤)
7. [æµç¨‹ 6ï¼šç®¡ç†å“¡å¯©æ ¸ - é€šé](#æµç¨‹-6ç®¡ç†å“¡å¯©æ ¸---é€šé)
8. [æµç¨‹ 7ï¼šæ¸…é™¤åŠŸèƒ½](#æµç¨‹-7æ¸…é™¤åŠŸèƒ½)
9. [ç‹€æ…‹è½‰æ›åœ–](#ç‹€æ…‹è½‰æ›åœ–)
10. [API å°æ‡‰è¡¨](#api-å°æ‡‰è¡¨)
11. [éŒ¯èª¤è™•ç†](#éŒ¯èª¤è™•ç†)

---

## æµç¨‹ç¸½è¦½

èƒ½æºå¡«å ±ç³»çµ±æœ‰ 7 å€‹æ ¸å¿ƒæµç¨‹ï¼š

| æµç¨‹ | ä½¿ç”¨è€… | ä¸»è¦å‹•ä½œ | ç‹€æ…‹è®ŠåŒ– |
|------|--------|---------|---------|
| 1 | ä½¿ç”¨è€… | é¦–æ¬¡å¡«å ± | null â†’ submitted |
| 2 | ä½¿ç”¨è€… | é‡æ–°é€²å…¥é é¢ | - |
| 3 | ä½¿ç”¨è€… | ä¿®æ”¹å·²æäº¤çš„è³‡æ–™ | submitted â†’ submitted |
| 4 | ç®¡ç†å“¡ | å¯©æ ¸é€€ä»¶ | submitted â†’ rejected |
| 5 | ä½¿ç”¨è€… | çœ‹åˆ°é€€ä»¶ä¸¦é‡æ–°æäº¤ | rejected â†’ submitted |
| 6 | ç®¡ç†å“¡ | å¯©æ ¸é€šé | submitted â†’ approved |
| 7 | ä½¿ç”¨è€… | æ¸…é™¤è³‡æ–™ | any â†’ null |

---

## æµç¨‹ 1ï¼šé¦–æ¬¡å¡«å ±

### ä½¿ç”¨å ´æ™¯
æ–°ä½¿ç”¨è€…ç¬¬ä¸€æ¬¡é€²å…¥æŸå€‹èƒ½æºé¡åˆ¥é é¢ï¼ˆä¾‹å¦‚ WD-40ï¼‰ï¼Œå°šæœªå¡«å¯«éä»»ä½•è³‡æ–™ã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 1-1ï¼šé€²å…¥é é¢
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - å¾å´é‚Šæ¬„é»æ“Šã€ŒWD-40ã€

ç³»çµ±è¡Œç‚ºï¼š
  1. å°èˆªåˆ° /app/wd40
  2. å‘¼å« getEntryByPageKeyAndYear('wd40', 2024)
  3. å›å‚³ nullï¼ˆå› ç‚ºæ²’æœ‰è³‡æ–™ï¼‰
  4. åˆå§‹åŒ–ç©ºç™½è¡¨å–®
  5. é¡¯ç¤ºç‹€æ…‹ï¼šç„¡ç‹€æ…‹æ¨™ç±¤
```

**ç›¸é—œ APIï¼š**
```typescript
const entry = await getEntryByPageKeyAndYear('wd40', 2024)
// å›å‚³: null
```

---

#### æ­¥é©Ÿ 1-2ï¼šå¡«å¯«è¡¨å–®
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - å¡«å¯«ã€Œå–®ä½å®¹é‡ã€ï¼š500
  - å¡«å¯«ã€Œç¢³æ’ä¿‚æ•¸ã€ï¼š85
  - å¡«å¯« 1 æœˆä½¿ç”¨é‡ï¼š10
  - å¡«å¯« 2 æœˆä½¿ç”¨é‡ï¼š15
  - ... (å…¶ä»–æœˆä»½)

ç³»çµ±è¡Œç‚ºï¼š
  - æ‰€æœ‰è³‡æ–™æš«å­˜åœ¨ React state
  - å°šæœªå¯«å…¥è³‡æ–™åº«
  - å³æ™‚è¨ˆç®—ç¸½ä½¿ç”¨é‡
```

**å‰ç«¯ç‹€æ…‹ï¼š**
```typescript
monthlyData: [
  { month: 1, quantity: 10 },
  { month: 2, quantity: 15 },
  // ...
]
unitCapacity: 500
carbonRate: 85
```

---

#### æ­¥é©Ÿ 1-3ï¼šä¸Šå‚³æª”æ¡ˆï¼ˆMSDSï¼‰
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»ã€Œä¸Šå‚³ MSDSã€
  - é¸æ“‡æª”æ¡ˆï¼šmsds-document.pdf

ç³»çµ±è¡Œç‚ºï¼š
  1. æª”æ¡ˆé©—è­‰ï¼ˆé¡å‹ã€å¤§å°ï¼‰
  2. è½‰æ›ç‚º MemoryFile æ ¼å¼
  3. å­˜åœ¨è¨˜æ†¶é«”ï¼ˆå°šæœªä¸Šå‚³åˆ° Supabase Storageï¼‰
  4. é¡¯ç¤ºé è¦½ï¼ˆåœ–ç‰‡ï¼‰æˆ–æª”åï¼ˆPDFï¼‰
```

**è¨˜æ†¶é«”æª”æ¡ˆçµæ§‹ï¼š**
```typescript
MemoryFile {
  file: File,           // åŸå§‹æª”æ¡ˆç‰©ä»¶
  file_name: "msds-document.pdf",
  preview_url: "blob:...",
  category: "msds"
}
```

---

#### æ­¥é©Ÿ 1-4ï¼šä¸Šå‚³æª”æ¡ˆï¼ˆæœˆä»½ä½¿ç”¨è­‰æ˜ï¼‰
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - åœ¨ 1 æœˆå€å¡Šä¸Šå‚³ï¼šinvoice-jan.jpg
  - åœ¨ 2 æœˆå€å¡Šä¸Šå‚³ï¼šinvoice-feb.jpg

ç³»çµ±è¡Œç‚ºï¼š
  - åŒæ¨£è½‰æ›ç‚º MemoryFile
  - æŒ‰æœˆä»½åˆ†é¡å­˜æ”¾
  - å°šæœªä¸Šå‚³åˆ° Supabase Storage
```

---

#### æ­¥é©Ÿ 1-5ï¼šé»æäº¤
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»ã€Œæäº¤å¡«å ±ã€æŒ‰éˆ•

ç³»çµ±è¡Œç‚ºï¼ˆä¾åºåŸ·è¡Œï¼‰ï¼š

A. é©—è­‰è³‡æ–™
   - æª¢æŸ¥å¿…å¡«æ¬„ä½
   - æª¢æŸ¥ç¸½ä½¿ç”¨é‡ > 0
   - æª¢æŸ¥æª”æ¡ˆæ•¸é‡ç¬¦åˆè¦ç¯„

B. å„²å­˜è¡¨å–®è³‡æ–™åˆ°è³‡æ–™åº«
   å‘¼å«ï¼šupsertEnergyEntry({
     page_key: 'wd40',
     period_year: 2024,
     unit: 'ML',
     monthly: { '1': 10, '2': 15, ... },
     payload: {
       unitCapacity: 500,
       carbonRate: 85,
       monthly: { '1': 10, '2': 15, ... }
     }
   })
   
   å›å‚³ï¼š{ entry_id: 'abc123' }
   è³‡æ–™åº«ç‹€æ…‹ï¼šstatus = 'submitted'

C. ä¸Šå‚³è¨˜æ†¶é«”æª”æ¡ˆåˆ° Supabase Storage
   é‡å°æ¯å€‹ MemoryFileï¼š
     1. uploadEvidenceWithEntry(file, {
          entryId: 'abc123',
          pageKey: 'wd40',
          year: 2024,
          category: 'msds'
        })
     2. æª”æ¡ˆä¸Šå‚³åˆ° Storage
     3. å¯«å…¥ evidence_files è¡¨
     4. è‡ªå‹•é—œè¯åˆ° entry_id

D. é—œè¯æ‰€æœ‰æª”æ¡ˆ
   å‘¼å«ï¼šcommitEvidence({
     entryId: 'abc123',
     pageKey: 'wd40'
   })
   
   ç¢ºä¿æ‰€æœ‰æª”æ¡ˆéƒ½æ­£ç¢ºé—œè¯åˆ°è¨˜éŒ„

E. æ›´æ–°å‰ç«¯ç‹€æ…‹
   - æ¸…ç©ºè¨˜æ†¶é«”æª”æ¡ˆ
   - è¨­å®š currentEntryId = 'abc123'
   - è¨­å®š hasSubmittedBefore = true
   - è¨­å®š currentStatus = 'submitted'

F. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
   - Toast: "æäº¤æˆåŠŸï¼å¹´åº¦ç¸½ä½¿ç”¨é‡ï¼šXXX ML"
   - é¡¯ç¤ºæˆåŠŸå½ˆçª—ï¼ˆå¯é¸ï¼‰
```

**ç›¸é—œ API å‘¼å«é †åºï¼š**
```typescript
1. const { entry_id } = await upsertEnergyEntry(input)
2. for (const file of msdsMemoryFiles) {
     await uploadEvidenceWithEntry(file, metadata)
   }
3. for (const file of monthlyMemoryFiles) {
     await uploadEvidenceWithEntry(file, metadata)
   }
4. await commitEvidence({ entryId, pageKey })
```

---

## æµç¨‹ 2ï¼šé‡æ–°é€²å…¥é é¢ï¼ˆè¼‰å…¥èˆŠè³‡æ–™ï¼‰

### ä½¿ç”¨å ´æ™¯
ä½¿ç”¨è€…å·²ç¶“æäº¤éè³‡æ–™ï¼Œé—œé–‰ç€è¦½å™¨æˆ–å°èˆªåˆ°å…¶ä»–é é¢å¾Œï¼Œå†æ¬¡å›åˆ°è©²èƒ½æºé¡åˆ¥é é¢ã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 2-1ï¼šé€²å…¥é é¢
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - å¾å´é‚Šæ¬„é»æ“Šã€ŒWD-40ã€

ç³»çµ±è¡Œç‚ºï¼š
  1. å°èˆªåˆ° /app/wd40
  2. å‘¼å« getEntryByPageKeyAndYear('wd40', 2024)
  3. å›å‚³ existing entryï¼ˆstatus = 'submitted'ï¼‰
  4. è¨­å®š currentEntryId = entry.id
  5. è¨­å®š hasSubmittedBefore = true
  6. è¨­å®š initialStatus = 'submitted'
```

**å›å‚³è³‡æ–™çµæ§‹ï¼š**
```typescript
EnergyEntry {
  id: 'abc123',
  owner_id: 'user456',
  page_key: 'wd40',
  period_year: 2024,
  category: 'WD-40',
  status: 'submitted',
  amount: 250,  // ç¸½ä½¿ç”¨é‡
  unit: 'ML',
  payload: {
    unitCapacity: 500,
    carbonRate: 85,
    monthly: { '1': 10, '2': 15, ... }
  },
  created_at: '2024-03-20T10:00:00',
  updated_at: '2024-03-20T10:00:00'
}
```

---

#### æ­¥é©Ÿ 2-2ï¼šè¼‰å…¥è¡¨å–®è³‡æ–™
```
ç³»çµ±è¡Œç‚ºï¼š
  1. å¾ payload.monthly è¼‰å…¥æœˆä»½è³‡æ–™
  2. å¾ payload.unitCapacity è¼‰å…¥å–®ä½å®¹é‡
  3. å¾ payload.carbonRate è¼‰å…¥ç¢³æ’ä¿‚æ•¸
  4. è¨ˆç®—ç¸½ä½¿ç”¨é‡
  5. æ›´æ–°å‰ç«¯ state
```

**å‰ç«¯ç‹€æ…‹æ›´æ–°ï¼š**
```typescript
setMonthlyData([
  { month: 1, quantity: 10 },
  { month: 2, quantity: 15 },
  // ...
])
setUnitCapacity(500)
setCarbonRate(85)
```

---

#### æ­¥é©Ÿ 2-3ï¼šè¼‰å…¥æª”æ¡ˆæ¸…å–®
```
ç³»çµ±è¡Œç‚ºï¼š
  1. å‘¼å« getEntryFiles('abc123')
  2. å›å‚³æ‰€æœ‰é—œè¯çš„æª”æ¡ˆ
  3. æŒ‰ category åˆ†é¡ï¼ˆmsds / usage_evidenceï¼‰
  4. æŒ‰ month åˆ†çµ„ï¼ˆusage_evidenceï¼‰
  5. æ›´æ–°å‰ç«¯ state
```

**å›å‚³æª”æ¡ˆçµæ§‹ï¼š**
```typescript
EvidenceFile[] = [
  {
    id: 'file1',
    entry_id: 'abc123',
    file_name: 'msds-document.pdf',
    file_path: 'evidence/wd40/2024/msds/...',
    category: 'msds',
    month: null,
    uploaded_at: '2024-03-20T10:00:00'
  },
  {
    id: 'file2',
    entry_id: 'abc123',
    file_name: 'invoice-jan.jpg',
    file_path: 'evidence/wd40/2024/usage/...',
    category: 'usage_evidence',
    month: 1,
    uploaded_at: '2024-03-20T10:00:00'
  },
  // ...
]
```

---

#### æ­¥é©Ÿ 2-4ï¼šé¡¯ç¤ºé é¢
```
é¡¯ç¤ºå…§å®¹ï¼š
  1. ç‹€æ…‹æ¨™ç±¤ï¼šã€Œå·²æäº¤ã€ï¼ˆè—è‰²ï¼‰
  2. è¡¨å–®ï¼šé¡¯ç¤ºæ‰€æœ‰å·²å¡«è³‡æ–™ï¼ˆå¯ç·¨è¼¯ï¼‰
  3. MSDS æª”æ¡ˆï¼šé¡¯ç¤ºå·²ä¸Šå‚³çš„æª”æ¡ˆ
  4. æœˆä»½æª”æ¡ˆï¼šé¡¯ç¤ºå„æœˆä»½å·²ä¸Šå‚³çš„æª”æ¡ˆ
  5. åº•éƒ¨æŒ‰éˆ•ï¼šã€Œæäº¤å¡«å ±ã€ã€Œæ¸…é™¤ã€

ç·¨è¼¯æ¬Šé™ï¼š
  - ç‹€æ…‹ = submitted â†’ å¯ç·¨è¼¯
  - ç‹€æ…‹ = approved â†’ å”¯è®€
  - ç‹€æ…‹ = rejected â†’ å¯ç·¨è¼¯
```

---

## æµç¨‹ 3ï¼šä¿®æ”¹å·²æäº¤çš„è³‡æ–™

### ä½¿ç”¨å ´æ™¯
ä½¿ç”¨è€…ç™¼ç¾å·²æäº¤çš„è³‡æ–™æœ‰èª¤ï¼Œæƒ³è¦ä¿®æ”¹è¡¨å–®æ¬„ä½æˆ–æª”æ¡ˆã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 3-1ï¼šä¿®æ”¹è¡¨å–®æ¬„ä½
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - ä¿®æ”¹ 1 æœˆä½¿ç”¨é‡ï¼š10 â†’ 12
  - ä¿®æ”¹ç¢³æ’ä¿‚æ•¸ï¼š85 â†’ 90

ç³»çµ±è¡Œç‚ºï¼š
  - æ›´æ–° React state
  - é‡æ–°è¨ˆç®—ç¸½ä½¿ç”¨é‡
  - å°šæœªå¯«å…¥è³‡æ–™åº«
  - é é¢ç‹€æ…‹ä¿æŒã€Œå·²æäº¤ã€
```

---

#### æ­¥é©Ÿ 3-2ï¼šåˆªé™¤èˆŠæª”æ¡ˆ
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»æ“ŠæŸå€‹æª”æ¡ˆçš„åˆªé™¤æŒ‰éˆ•
  - ç¢ºèªåˆªé™¤

ç³»çµ±è¡Œç‚ºï¼š
  1. å‘¼å« deleteEvidenceFile(fileId)
  2. å¾ evidence_files è¡¨åˆªé™¤è¨˜éŒ„
  3. å¾ Supabase Storage åˆªé™¤å¯¦é«”æª”æ¡ˆ
  4. æ›´æ–°å‰ç«¯ stateï¼ˆç§»é™¤è©²æª”æ¡ˆï¼‰
```

**ç›¸é—œ APIï¼š**
```typescript
await deleteEvidenceFile('file1')
// çµæœï¼šæª”æ¡ˆå¾è³‡æ–™åº«å’Œ Storage åˆªé™¤
```

---

#### æ­¥é©Ÿ 3-3ï¼šä¸Šå‚³æ–°æª”æ¡ˆ
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - ä¸Šå‚³æ–°çš„ MSDS æª”æ¡ˆ

ç³»çµ±è¡Œç‚ºï¼š
  - è½‰æ›ç‚º MemoryFile
  - å­˜åœ¨è¨˜æ†¶é«”
  - å°šæœªä¸Šå‚³åˆ° Supabase Storage
  - é¡¯ç¤ºé è¦½
```

---

#### æ­¥é©Ÿ 3-4ï¼šé‡æ–°æäº¤
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»ã€Œæäº¤å¡«å ±ã€æŒ‰éˆ•

ç³»çµ±è¡Œç‚ºï¼š

A. æ›´æ–°è³‡æ–™åº«è¨˜éŒ„
   å‘¼å«ï¼šupsertEnergyEntry({
     page_key: 'wd40',
     period_year: 2024,
     unit: 'ML',
     monthly: { '1': 12, '2': 15, ... },  // ä¿®æ”¹å¾Œçš„è³‡æ–™
     payload: {
       unitCapacity: 500,
       carbonRate: 90,  // ä¿®æ”¹å¾Œçš„ä¿‚æ•¸
       monthly: { '1': 12, '2': 15, ... }
     }
   })
   
   çµæœï¼š
   - æ‰¾åˆ°ç¾æœ‰è¨˜éŒ„ï¼ˆentry_id = 'abc123'ï¼‰
   - è¦†è“‹ payloadï¼ˆèˆŠè³‡æ–™æ¶ˆå¤±ï¼Œä¸ä¿ç•™æ­·å²ï¼‰
   - æ›´æ–° amountï¼ˆç¸½ä½¿ç”¨é‡ï¼‰
   - æ›´æ–° updated_at
   - ç‹€æ…‹ç¶­æŒ 'submitted'

B. ä¸Šå‚³æ–°çš„è¨˜æ†¶é«”æª”æ¡ˆ
   - å¦‚æœæœ‰æ–°çš„ MemoryFile
   - å‘¼å« uploadEvidenceWithEntry()
   - è‡ªå‹•é—œè¯åˆ° entry_id = 'abc123'

C. é‡æ–°é—œè¯æª”æ¡ˆ
   - å‘¼å« commitEvidence()
   - ç¢ºä¿æ‰€æœ‰æª”æ¡ˆæ­£ç¢ºé—œè¯

D. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
   - Toast: "æäº¤æˆåŠŸï¼å¹´åº¦ç¸½ä½¿ç”¨é‡ï¼šXXX ML"
```

**æœ€çµ‚çµæœï¼š**
```
è³‡æ–™åº«ä¸­çš„è¨˜éŒ„ï¼š
- entry_id: 'abc123'ï¼ˆä¸è®Šï¼‰
- payload: æ–°çš„è³‡æ–™ï¼ˆè¦†è“‹èˆŠçš„ï¼‰
- amount: æ–°çš„ç¸½é‡
- status: 'submitted'ï¼ˆç¶­æŒï¼‰

æª”æ¡ˆï¼š
- èˆŠæª”æ¡ˆ Aï¼šå·²åˆªé™¤
- æ–°æª”æ¡ˆ aï¼šå·²ä¸Šå‚³
- å…¶ä»–æª”æ¡ˆ B, Cï¼šä¿æŒä¸è®Š

çµæœï¼šSupabase å­˜çš„æ˜¯ a, B, C
```

---

## æµç¨‹ 4ï¼šç®¡ç†å“¡å¯©æ ¸ - é€€ä»¶

### ä½¿ç”¨å ´æ™¯
ç®¡ç†å“¡æª¢æŸ¥ä½¿ç”¨è€…æäº¤çš„è³‡æ–™ï¼Œç™¼ç¾å•é¡Œéœ€è¦é€€å›ä¿®æ­£ã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 4-1ï¼šç®¡ç†å“¡é€²å…¥å¯©æ ¸æ¨¡å¼
```
ç³»çµ±è¡Œç‚ºï¼š
  1. ç®¡ç†å“¡å¾å¯©æ ¸åˆ—è¡¨é»æ“ŠæŸç­†è¨˜éŒ„
  2. å°èˆªåˆ°ï¼š/app/wd40?mode=review&entryId=abc123&userId=user456
  3. æª¢æ¸¬åˆ° URL åƒæ•¸ mode=review
  4. è¨­å®š isReviewMode = true
  5. å‘¼å« getEntryById('abc123')
  6. è¼‰å…¥è©²ä½¿ç”¨è€…çš„è³‡æ–™

é é¢é¡¯ç¤ºï¼š
  - è¡¨å–®ï¼šå”¯è®€ï¼ˆä¸èƒ½ç·¨è¼¯ï¼‰
  - æª”æ¡ˆï¼šå¯æª¢è¦–ã€å¯ä¸‹è¼‰ã€ä¸èƒ½åˆªé™¤
  - åº•éƒ¨ï¼šéš±è—ã€Œæäº¤ã€å’Œã€Œæ¸…é™¤ã€æŒ‰éˆ•
  - å¯©æ ¸å€ï¼šé¡¯ç¤ºã€Œé€šéã€å’Œã€Œé€€ä»¶ã€æŒ‰éˆ•
```

**å¯©æ ¸æ¨¡å¼ç‰¹å¾µï¼š**
```typescript
isReviewMode = true
reviewEntryId = 'abc123'
reviewUserId = 'user456'

editPermissions = {
  canEdit: false,        // ä¸èƒ½ç·¨è¼¯è¡¨å–®
  canUpload: false,      // ä¸èƒ½ä¸Šå‚³æª”æ¡ˆ
  canDelete: false,      // ä¸èƒ½åˆªé™¤æª”æ¡ˆ
  canSubmit: false       // ä¸èƒ½æäº¤
}
```

---

#### æ­¥é©Ÿ 4-2ï¼šç®¡ç†å“¡æª¢è¦–è³‡æ–™
```
ç®¡ç†å“¡å‹•ä½œï¼š
  - æª¢è¦–è¡¨å–®è³‡æ–™
  - ä¸‹è¼‰ MSDS æª”æ¡ˆ
  - æª¢è¦–æœˆä»½ä½¿ç”¨è­‰æ˜
  - ç™¼ç¾ï¼šMSDS æª”æ¡ˆä¸å®Œæ•´

ç³»çµ±è¡Œç‚ºï¼š
  - æä¾›æª”æ¡ˆé è¦½ï¼ˆåœ–ç‰‡ï¼‰
  - æä¾›æª”æ¡ˆä¸‹è¼‰ï¼ˆPDFï¼‰
  - æ‰€æœ‰è³‡æ–™å”¯è®€
```

---

#### æ­¥é©Ÿ 4-3ï¼šç®¡ç†å“¡é»é€€ä»¶
```
ç®¡ç†å“¡å‹•ä½œï¼š
  1. é»ã€Œé€€ä»¶ã€æŒ‰éˆ•
  2. å½ˆå‡ºè¼¸å…¥æ¡†
  3. è¼¸å…¥é€€ä»¶åŸå› ï¼š"MSDS æª”æ¡ˆä¸å®Œæ•´ï¼Œè«‹è£œå……ç”¢å“å®‰å…¨è³‡æ–™è¡¨"
  4. ç¢ºèªé€€ä»¶

ç³»çµ±è¡Œç‚ºï¼š
  1. å‘¼å« reviewEntry('abc123', 'reject', 'é€€ä»¶åŸå› ')
  2. æ›´æ–°è³‡æ–™åº«
  3. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  4. å°èˆªå›ä¸Šä¸€é ï¼ˆå¯©æ ¸åˆ—è¡¨ï¼‰
```

**API å‘¼å«ï¼š**
```typescript
await reviewEntry(
  'abc123',           // entryId
  'reject',           // action
  'MSDS æª”æ¡ˆä¸å®Œæ•´ï¼Œè«‹è£œå……ç”¢å“å®‰å…¨è³‡æ–™è¡¨'  // notes
)
```

**è³‡æ–™åº«æ›´æ–°ï¼š**
```sql
UPDATE energy_entries
SET 
  status = 'rejected',
  review_notes = 'MSDS æª”æ¡ˆä¸å®Œæ•´ï¼Œè«‹è£œå……ç”¢å“å®‰å…¨è³‡æ–™è¡¨',
  reviewed_at = '2024-03-23T10:30:00',
  reviewer_id = 'admin123',
  is_locked = false
WHERE id = 'abc123'
```

---

## æµç¨‹ 5ï¼šä½¿ç”¨è€…çœ‹åˆ°é€€ä»¶ä¸¦é‡æ–°æäº¤

### ä½¿ç”¨å ´æ™¯
ä½¿ç”¨è€…çš„å¡«å ±è¢«ç®¡ç†å“¡é€€å›ï¼Œéœ€è¦ä¿®æ­£å¾Œé‡æ–°æäº¤ã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 5-1ï¼šä½¿ç”¨è€…é€²å…¥é é¢
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - å¾å´é‚Šæ¬„é»æ“Šã€ŒWD-40ã€

ç³»çµ±è¡Œç‚ºï¼š
  1. å‘¼å« getEntryByPageKeyAndYear('wd40', 2024)
  2. å›å‚³ entryï¼ˆstatus = 'rejected'ï¼‰
  3. æª¢æ¸¬åˆ°é€€ä»¶ç‹€æ…‹
  4. é¡¯ç¤ºé€€ä»¶è­¦å‘Šæ©«å¹…
```

**é é¢é¡¯ç¤ºï¼š**
```
ç´…è‰²è­¦å‘Šæ©«å¹…ï¼ˆé é¢æœ€ä¸Šæ–¹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸  å¡«å ±å·²è¢«é€€å›                        â”‚
â”‚                                        â”‚
â”‚ é€€å›åŸå› ï¼šMSDS æª”æ¡ˆä¸å®Œæ•´ï¼Œè«‹è£œå……ç”¢å“   â”‚
â”‚           å®‰å…¨è³‡æ–™è¡¨                    â”‚
â”‚                                        â”‚
â”‚ è«‹æ ¹æ“šä¸Šè¿°åŸå› ä¿®æ­£å¾Œé‡æ–°æäº¤ã€‚ä¿®æ­£å®Œæˆ   â”‚
â”‚ å¾Œï¼Œè³‡æ–™å°‡é‡æ–°é€²å…¥å¯©æ ¸æµç¨‹ã€‚            â”‚
â”‚                                        â”‚
â”‚ é€€å›æ™‚é–“ï¼š2024-03-23 10:30:00          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¡¨å–®ç‹€æ…‹ï¼šå¯ç·¨è¼¯
æª”æ¡ˆï¼šå¯å¢åˆª
åº•éƒ¨æŒ‰éˆ•ï¼šã€Œæäº¤å¡«å ±ã€ã€Œæ¸…é™¤ã€
```

---

#### æ­¥é©Ÿ 5-2ï¼šä½¿ç”¨è€…ä¿®æ­£å•é¡Œ
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - åˆªé™¤ä¸å®Œæ•´çš„ MSDS æª”æ¡ˆ
  - ä¸Šå‚³å®Œæ•´çš„ MSDS æª”æ¡ˆï¼ˆåŒ…å«ç”¢å“å®‰å…¨è³‡æ–™è¡¨ï¼‰
  - æª¢æŸ¥å…¶ä»–è³‡æ–™

ç³»çµ±è¡Œç‚ºï¼š
  - åˆªé™¤èˆŠæª”æ¡ˆï¼šdeleteEvidenceFile()
  - æ–°æª”æ¡ˆå­˜è¨˜æ†¶é«”ï¼šMemoryFile
  - è¡¨å–®è³‡æ–™ç¶­æŒåŸæ¨£ï¼ˆæˆ–å¯ä¿®æ”¹ï¼‰
```

---

#### æ­¥é©Ÿ 5-3ï¼šé‡æ–°æäº¤
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»ã€Œæäº¤å¡«å ±ã€æŒ‰éˆ•

ç³»çµ±è¡Œç‚ºï¼š

A. æ›´æ–°è³‡æ–™åº«è¨˜éŒ„
   å‘¼å«ï¼šupsertEnergyEntry(...)
   
   è³‡æ–™åº«æ›´æ–°ï¼š
   - payload: æœ€æ–°çš„è¡¨å–®è³‡æ–™
   - status: 'rejected' â†’ 'submitted'
   - review_notes: æ¸…ç©ºï¼ˆnullï¼‰
   - reviewed_at: æ¸…ç©ºï¼ˆnullï¼‰
   - reviewer_id: æ¸…ç©ºï¼ˆnullï¼‰
   - updated_at: æ›´æ–°ç‚ºç•¶å‰æ™‚é–“

B. ä¸Šå‚³æ–°çš„ MSDS æª”æ¡ˆ
   - uploadEvidenceWithEntry()
   - é—œè¯åˆ°åŒä¸€å€‹ entry_id

C. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
   - Toast: "é‡æ–°æäº¤æˆåŠŸï¼Œç­‰å¾…å¯©æ ¸"
   - éš±è—ç´…è‰²è­¦å‘Šæ©«å¹…
   - é¡¯ç¤ºè—è‰²ã€Œå·²æäº¤ã€æ¨™ç±¤
```

**ç‹€æ…‹è®ŠåŒ–ï¼š**
```
before: status = 'rejected', review_notes = 'é€€ä»¶åŸå› '
after:  status = 'submitted', review_notes = null
```

---

## æµç¨‹ 6ï¼šç®¡ç†å“¡å¯©æ ¸ - é€šé

### ä½¿ç”¨å ´æ™¯
ç®¡ç†å“¡æª¢æŸ¥ä½¿ç”¨è€…æäº¤ï¼ˆæˆ–é‡æ–°æäº¤ï¼‰çš„è³‡æ–™ï¼Œç¢ºèªç„¡èª¤å¾Œé€šéå¯©æ ¸ã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 6-1ï¼šç®¡ç†å“¡é€²å…¥å¯©æ ¸æ¨¡å¼
```
ç³»çµ±è¡Œç‚ºï¼š
  1. å°èˆªåˆ°ï¼š/app/wd40?mode=review&entryId=abc123&userId=user456
  2. è¼‰å…¥å¾…å¯©æ ¸çš„è³‡æ–™
  3. é é¢è®Šå”¯è®€
  4. é¡¯ç¤ºã€Œé€šéã€å’Œã€Œé€€ä»¶ã€æŒ‰éˆ•
```

---

#### æ­¥é©Ÿ 6-2ï¼šç®¡ç†å“¡é»é€šé
```
ç®¡ç†å“¡å‹•ä½œï¼š
  1. æª¢è¦–æ‰€æœ‰è³‡æ–™
  2. ç¢ºèªç„¡èª¤
  3. é»ã€Œé€šéã€æŒ‰éˆ•
  4. ç¢ºèªé€šé

ç³»çµ±è¡Œç‚ºï¼š
  1. å‘¼å« reviewEntry('abc123', 'approve', '')
  2. æ›´æ–°è³‡æ–™åº«
  3. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
  4. å°èˆªå›ä¸Šä¸€é ï¼ˆå¯©æ ¸åˆ—è¡¨ï¼‰
```

**API å‘¼å«ï¼š**
```typescript
await reviewEntry(
  'abc123',    // entryId
  'approve',   // action
  ''           // notesï¼ˆé€šéæ™‚ç‚ºç©ºï¼‰
)
```

**è³‡æ–™åº«æ›´æ–°ï¼š**
```sql
UPDATE energy_entries
SET 
  status = 'approved',
  review_notes = null,
  reviewed_at = '2024-03-23T14:00:00',
  reviewer_id = 'admin123',
  is_locked = true    -- ğŸ”’ é–å®šè³‡æ–™
WHERE id = 'abc123'
```

---

#### æ­¥é©Ÿ 6-3ï¼šä½¿ç”¨è€…çœ‹åˆ°é€šéç‹€æ…‹
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é€²å…¥ WD-40 é é¢

ç³»çµ±è¡Œç‚ºï¼š
  1. å‘¼å« getEntryByPageKeyAndYear('wd40', 2024)
  2. å›å‚³ entryï¼ˆstatus = 'approved', is_locked = trueï¼‰
  3. æª¢æ¸¬åˆ°é€šéç‹€æ…‹
  4. é¡¯ç¤ºé€šéç¥è³€æ©«å¹…
```

**é é¢é¡¯ç¤ºï¼š**
```
ç¶ è‰²ç¥è³€æ©«å¹…ï¼ˆé é¢æœ€ä¸Šæ–¹ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‰  æ­å–œæ‚¨å·²å¯©æ ¸é€šéï¼                  â”‚
â”‚                                        â”‚
â”‚ æ­¤å¡«å ±å·²å®Œæˆå¯©æ ¸ï¼Œè³‡æ–™å·²é–å®šç„¡æ³•ä¿®æ”¹ã€‚   â”‚
â”‚                                        â”‚
â”‚ å¯©æ ¸å®Œæˆæ™‚é–“ï¼š2024-03-23 14:00:00      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¡¨å–®ç‹€æ…‹ï¼šå”¯è®€ï¼ˆä¸èƒ½ç·¨è¼¯ï¼‰
æª”æ¡ˆï¼šåªèƒ½æª¢è¦–å’Œä¸‹è¼‰ï¼Œä¸èƒ½åˆªé™¤
åº•éƒ¨æŒ‰éˆ•ï¼šå…¨éƒ¨éš±è—
```

**ç·¨è¼¯æ¬Šé™ï¼š**
```typescript
editPermissions = {
  canEdit: false,      // âŒ ä¸èƒ½ç·¨è¼¯è¡¨å–®
  canUpload: false,    // âŒ ä¸èƒ½ä¸Šå‚³æª”æ¡ˆ
  canDelete: false,    // âŒ ä¸èƒ½åˆªé™¤æª”æ¡ˆ
  canSubmit: false,    // âŒ ä¸èƒ½æäº¤
  canClear: false      // âŒ ä¸èƒ½æ¸…é™¤
}
```

---

## æµç¨‹ 7ï¼šæ¸…é™¤åŠŸèƒ½

### ä½¿ç”¨å ´æ™¯
ä½¿ç”¨è€…æƒ³è¦æ¸…é™¤æ‰€æœ‰å·²å¡«å¯«çš„è³‡æ–™ï¼Œé‡æ–°é–‹å§‹ã€‚

### æ­¥é©Ÿè©³è§£

#### æ­¥é©Ÿ 7-1ï¼šä½¿ç”¨è€…é»æ¸…é™¤
```
ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»ã€Œæ¸…é™¤ã€æŒ‰éˆ•

ç³»çµ±è¡Œç‚ºï¼š
  1. æª¢æŸ¥ç•¶å‰ç‹€æ…‹
  2. å¦‚æœ status = 'approved'ï¼šæŒ‰éˆ•ç¦ç”¨ï¼Œç„¡æ³•é»æ“Š
  3. å¦‚æœ status â‰  'approved'ï¼šé¡¯ç¤ºç¢ºèªå½ˆçª—
```

**æ¸…é™¤æŒ‰éˆ•å¯ç”¨æ€§ï¼š**
```typescript
const canClear = currentStatus !== 'approved'

<button disabled={!canClear}>
  æ¸…é™¤
</button>
```

---

#### æ­¥é©Ÿ 7-2ï¼šç¢ºèªæ¸…é™¤
```
ç¢ºèªå½ˆçª—å…§å®¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ¸…é™¤è³‡æ–™ç¢ºèª                    â”‚
â”‚                                        â”‚
â”‚ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ WD-40 è³‡æ–™å—ï¼Ÿ           â”‚
â”‚ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼ŒåŒ…æ‹¬å·²ä¿å­˜åˆ°è³‡æ–™åº«çš„     â”‚
â”‚ è¨˜éŒ„å’Œæª”æ¡ˆã€‚                           â”‚
â”‚                                        â”‚
â”‚        [å–æ¶ˆ]        [ç¢ºå®šæ¸…é™¤]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨è€…å‹•ä½œï¼š
  - é»ã€Œç¢ºå®šæ¸…é™¤ã€
```

---

#### æ­¥é©Ÿ 7-3ï¼šåŸ·è¡Œæ¸…é™¤
```
ç³»çµ±è¡Œç‚ºï¼š

A. åˆªé™¤è³‡æ–™åº«è¨˜éŒ„
   å‘¼å«ï¼šdeleteEnergyEntry('abc123')
   
   è³‡æ–™åº«è¡Œç‚ºï¼ˆç´šè¯åˆªé™¤ï¼‰ï¼š
   1. åˆªé™¤ energy_entries è¨˜éŒ„
   2. è‡ªå‹•åˆªé™¤ evidence_files é—œè¯è¨˜éŒ„
   3. å¾ Supabase Storage åˆªé™¤å¯¦é«”æª”æ¡ˆ

B. æ¸…ç©ºå‰ç«¯ state
   - æ¸…ç©ºæ‰€æœ‰è¡¨å–®æ¬„ä½
   - æ¸…ç©ºè¨˜æ†¶é«”æª”æ¡ˆ
   - é‡ç½®ç‹€æ…‹
   - æ¸…ç©º currentEntryId
   - è¨­å®š hasSubmittedBefore = false

C. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
   - Toast: "è³‡æ–™å·²æ¸…é™¤"
   - é é¢å›åˆ°åˆå§‹ç‹€æ…‹ï¼ˆå¦‚åŒé¦–æ¬¡é€²å…¥ï¼‰
```

**API å‘¼å«ï¼š**
```typescript
await deleteEnergyEntry('abc123')
// çµæœï¼šè¨˜éŒ„å’Œæ‰€æœ‰é—œè¯æª”æ¡ˆè¢«åˆªé™¤
```

**å‰ç«¯ç‹€æ…‹é‡ç½®ï¼š**
```typescript
setMonthlyData(Array.from({ length: 12 }, (_, i) => ({
  month: i + 1,
  quantity: 0,
  totalUsage: 0,
  files: []
})))
setUnitCapacity(0)
setCarbonRate(0)
setMsdsFiles([])
setMsdsMemoryFiles([])
setCurrentEntryId(null)
setHasSubmittedBefore(false)
setCurrentStatus('submitted')
```

---

## ç‹€æ…‹è½‰æ›åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç‹€æ…‹è½‰æ›æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    nullï¼ˆç„¡è³‡æ–™ï¼‰
      â”‚
      â”‚ é¦–æ¬¡æäº¤
      â”‚ upsertEnergyEntry()
      â†“
    submittedï¼ˆå·²æäº¤ï¼‰
      â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                  â”‚
      â”‚ ä¿®æ”¹å¾Œé‡æ–°æäº¤      â”‚ ä½¿ç”¨è€…ä¿®æ­£å¾Œæäº¤
      â”‚ upsertEnergyEntry() â”‚ upsertEnergyEntry()
      â”‚                  â”‚
      â†“                  â”‚
    ç®¡ç†å“¡å¯©æ ¸            â”‚
      â”‚                  â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚         â”‚         â”‚
      â”‚ approve â”‚  reject â”‚
      â”‚         â”‚         â”‚
      â†“         â†“         â†“
  approved   rejected â”€â”€â”€â”€â”˜
 ï¼ˆé€šéï¼‰    ï¼ˆé€€ä»¶ï¼‰
   â”‚
   â”‚ ğŸ”’ is_locked = true
   â”‚ ä¸èƒ½ç·¨è¼¯
   â”‚ ä¸èƒ½æ¸…é™¤
   â”‚
   â””â”€â†’ æœ€çµ‚ç‹€æ…‹


æ¸…é™¤åŠŸèƒ½ï¼š
- submitted â†’ null  âœ… å¯æ¸…é™¤
- rejected â†’ null   âœ… å¯æ¸…é™¤
- approved â†’ null   âŒ ä¸å¯æ¸…é™¤ï¼ˆæŒ‰éˆ•ç¦ç”¨ï¼‰
```

---

## API å°æ‡‰è¡¨

### è³‡æ–™æ“ä½œ API

| åŠŸèƒ½ | API å‡½å¼ | åƒæ•¸ | å›å‚³å€¼ | èªªæ˜ |
|------|---------|------|--------|------|
| è¼‰å…¥èˆŠè³‡æ–™ | `getEntryByPageKeyAndYear` | `pageKey: string`<br>`year: number` | `EnergyEntry \| null` | è¼‰å…¥ä½¿ç”¨è€…æŸå¹´åº¦çš„å¡«å ±è¨˜éŒ„ |
| æ–°å¢/æ›´æ–°è¨˜éŒ„ | `upsertEnergyEntry` | `input: UpsertEntryInput` | `{ entry_id: string }` | æ–°å¢æˆ–æ›´æ–°å¡«å ±è¨˜éŒ„<br>ç‹€æ…‹è¨­ç‚º submitted |
| æ›´æ–°ç‹€æ…‹ | `updateEntryStatus` | `entryId: string`<br>`status: EntryStatus` | `void` | æ‰‹å‹•æ›´æ–°è¨˜éŒ„ç‹€æ…‹ |
| å–å¾—å–®ç­†è¨˜éŒ„ | `getEntryById` | `entryId: string` | `EnergyEntry \| null` | ç®¡ç†å“¡ç”¨ï¼šè¼‰å…¥ç‰¹å®šè¨˜éŒ„ |
| åˆªé™¤è¨˜éŒ„ | `deleteEnergyEntry` | `entryId: string` | `void` | åˆªé™¤è¨˜éŒ„ï¼ˆç´šè¯åˆªé™¤æª”æ¡ˆï¼‰ |

### æª”æ¡ˆæ“ä½œ API

| åŠŸèƒ½ | API å‡½å¼ | åƒæ•¸ | å›å‚³å€¼ | èªªæ˜ |
|------|---------|------|--------|------|
| ä¸Šå‚³æª”æ¡ˆ | `uploadEvidenceWithEntry` | `file: File`<br>`metadata: object` | `EvidenceFile` | ä¸Šå‚³æª”æ¡ˆåˆ° Storage<br>ä¸¦å¯«å…¥ evidence_files |
| é—œè¯æª”æ¡ˆ | `commitEvidence` | `{ entryId, pageKey }` | `void` | ç¢ºèªæ‰€æœ‰æª”æ¡ˆæ­£ç¢ºé—œè¯ |
| è¼‰å…¥æª”æ¡ˆæ¸…å–® | `getEntryFiles` | `entryId: string` | `EvidenceFile[]` | è¼‰å…¥è¨˜éŒ„çš„æ‰€æœ‰æª”æ¡ˆ |
| åˆªé™¤æª”æ¡ˆ | `deleteEvidenceFile` | `fileId: string` | `void` | åˆªé™¤æª”æ¡ˆï¼ˆè³‡æ–™åº«+Storageï¼‰ |
| åˆ—å‡º MSDS | `listMSDSFiles` | `pageKey: string` | `EvidenceFile[]` | åˆ—å‡ºæŸé¡åˆ¥çš„ MSDS |
| åˆ—å‡ºä½¿ç”¨è­‰æ˜ | `listUsageEvidenceFiles` | `pageKey: string`<br>`year: number` | `EvidenceFile[]` | åˆ—å‡ºæŸé¡åˆ¥æŸå¹´çš„ä½¿ç”¨è­‰æ˜ |

### å¯©æ ¸æ“ä½œ API

| åŠŸèƒ½ | API å‡½å¼ | åƒæ•¸ | å›å‚³å€¼ | èªªæ˜ |
|------|---------|------|--------|------|
| å¯©æ ¸æ“ä½œ | `reviewEntry` | `entryId: string`<br>`action: 'approve'\|'reject'`<br>`notes?: string` | `void` | åŸ·è¡Œé€šéæˆ–é€€ä»¶<br>é€šéæœƒé–å®šè³‡æ–™ |

---

## éŒ¯èª¤è™•ç†

### å¸¸è¦‹éŒ¯èª¤æƒ…æ³

#### 1. ç¶²è·¯éŒ¯èª¤
```
æƒ…å¢ƒï¼šä¸Šå‚³æª”æ¡ˆæ™‚ç¶²è·¯ä¸­æ–·

è™•ç†ï¼š
- é¡¯ç¤ºéŒ¯èª¤ Toast
- ä¿ç•™è¨˜æ†¶é«”æª”æ¡ˆ
- ä½¿ç”¨è€…å¯é‡æ–°æäº¤
- ä½¿ç”¨ Promise.allSettled éƒ¨åˆ†æˆåŠŸè™•ç†
```

#### 2. æ¬Šé™éŒ¯èª¤
```
æƒ…å¢ƒï¼šRLS æ”¿ç­–é˜»æ“‹æ“ä½œ

è™•ç†ï¼š
- æª¢æŸ¥èªè­‰ç‹€æ…‹
- é¡¯ç¤ºå‹å–„éŒ¯èª¤è¨Šæ¯
- æä¾›é‡æ–°ç™»å…¥é¸é …
```

#### 3. æª”æ¡ˆä¸Šå‚³å¤±æ•—
```
æƒ…å¢ƒï¼šæª”æ¡ˆå¤ªå¤§æˆ–æ ¼å¼éŒ¯èª¤

è™•ç†ï¼š
- å‰ç«¯é©—è­‰ï¼šæª”æ¡ˆé¡å‹ã€å¤§å°
- å¾Œç«¯é©—è­‰ï¼šSupabase Storage é™åˆ¶
- é¡¯ç¤ºå…·é«”éŒ¯èª¤åŸå› 
```

#### 4. è³‡æ–™é©—è­‰å¤±æ•—
```
æƒ…å¢ƒï¼šç¸½ä½¿ç”¨é‡ç‚º 0

è™•ç†ï¼š
- å‰ç«¯é©—è­‰ï¼šæäº¤å‰æª¢æŸ¥
- å¾Œç«¯é©—è­‰ï¼šè³‡æ–™åº«ç´„æŸ
- é¡¯ç¤ºï¼šã€Œç¸½ä½¿ç”¨é‡å¿…é ˆå¤§æ–¼ 0ã€
```

---

## å¸¸è¦‹å•é¡Œ FAQ

### Q1ï¼šä¿®æ”¹å·²æäº¤çš„è³‡æ–™æœƒä¿ç•™æ­·å²ç‰ˆæœ¬å—ï¼Ÿ
**Aï¼šä¸æœƒã€‚** æ¯æ¬¡æäº¤éƒ½æœƒè¦†è“‹èˆŠè³‡æ–™ï¼Œä¸ä¿ç•™æ­·å²ç‰ˆæœ¬ã€‚

---

### Q2ï¼šé€šéå¯©æ ¸å¾Œé‚„èƒ½ä¿®æ”¹å—ï¼Ÿ
**Aï¼šä¸èƒ½ã€‚** status = 'approved' ä¸” is_locked = true æ™‚ï¼Œæ‰€æœ‰ç·¨è¼¯åŠŸèƒ½éƒ½æœƒç¦ç”¨ã€‚

---

### Q3ï¼šæ¸…é™¤åŠŸèƒ½ä»€éº¼æ™‚å€™å¯ä»¥ç”¨ï¼Ÿ
**Aï¼šé™¤äº† approved ç‹€æ…‹ï¼Œå…¶ä»–æ™‚å€™éƒ½å¯ä»¥ç”¨ã€‚**
- submitted â†’ å¯æ¸…é™¤
- rejected â†’ å¯æ¸…é™¤
- approved â†’ ä¸å¯æ¸…é™¤ï¼ˆæŒ‰éˆ•ç¦ç”¨ï¼‰

---

### Q4ï¼šè¨˜æ†¶é«”æª”æ¡ˆä»€éº¼æ™‚å€™ä¸Šå‚³åˆ° Supabaseï¼Ÿ
**Aï¼šé»ã€Œæäº¤å¡«å ±ã€æ™‚ã€‚** ä¸Šå‚³å‰æª”æ¡ˆåªå­˜åœ¨ç€è¦½å™¨è¨˜æ†¶é«”ï¼Œé—œé–‰é é¢å°±æ¶ˆå¤±ã€‚

---

### Q5ï¼šç®¡ç†å“¡å¯©æ ¸å¾Œæœƒå°èˆªåˆ°å“ªè£¡ï¼Ÿ
**Aï¼šå›åˆ°ä¸Šä¸€é ï¼ˆå¯©æ ¸åˆ—è¡¨ï¼‰ã€‚** ä½¿ç”¨ `navigate(-1)`ã€‚

---

### Q6ï¼šæª”æ¡ˆåˆªé™¤æ˜¯ç«‹å³ç”Ÿæ•ˆå—ï¼Ÿ
**Aï¼šæ˜¯ã€‚** å‘¼å« deleteEvidenceFile() æœƒç«‹å³å¾è³‡æ–™åº«å’Œ Storage åˆªé™¤ã€‚

---

## ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´å…§å®¹ |
|------|------|---------|
| v1.0 | 2025-01-01 | åˆç‰ˆï¼ŒåŒ…å« 7 å€‹å®Œæ•´æµç¨‹ |

---

**ç›¸é—œæ–‡ä»¶ï¼š**
- [é‡æ§‹è¨ˆç•«](./REFACTORING_PLAN.md)
- [Hook ä½¿ç”¨èªªæ˜](./HOOKS.md)ï¼ˆå¾…æ’°å¯«ï¼‰
- [å…±ç”¨çµ„ä»¶èªªæ˜](./COMPONENTS.md)ï¼ˆå¾…æ’°å¯«ï¼‰
- [é·ç§»æŒ‡å—](./MIGRATION_GUIDE.md)ï¼ˆå¾…æ’°å¯«ï¼‰