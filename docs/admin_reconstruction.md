# 管理員頁面重構 PRD (Product Requirements Document)

---
**版本**: 1.0  
**日期**: 2025-09-20  
**狀態**: 待審核  
**負責人**: 開發團隊  

---

## 📋 專案概述

### 目標
重新設計碳足跡盤查系統的管理員介面，提供簡約、美觀、實用的用戶體驗，同時保持現有 API 接口和核心功能不變。

### 設計原則
- **簡約**：減少視覺雜訊，突出核心功能
- **美觀**：現代化設計語言，統一視覺風格
- **實用**：優化操作流程，提升工作效率

---

## 🎯 核心需求

### 1. 用戶管理系統增強

#### 1.1 創建用戶功能擴展
**當前狀態**: 基本用戶創建（姓名、email、公司等）  
**目標狀態**: 全功能用戶創建與配置

**新增功能**:
- ✅ **基本資料**：姓名、email、公司、職位、電話
- 🆕 **可見類別設定**：從14個能源類別中選擇用戶可填報的項目
- 🆕 **填報年份設定**：指定用戶需要填報的目標年份
- 🆕 **柴油發電機版本**：選擇加油版或測試版
- ✅ **用戶角色**：管理員/一般用戶
- ✅ **啟用狀態**：預設啟用

**技術實現**:
```json
// profiles.filling_config 擴展結構
{
  "diesel_generator_mode": "refuel|test",
  "visible_categories": ["wd40", "acetylene", "natural_gas", ...],
  "target_year": 2024
}
```

#### 1.2 用戶配置管理
**功能需求**:
- 📝 **後續編輯**：管理員可隨時調整用戶的可見類別、年份、柴油發電機版本
- 🔄 **版本切換**：柴油發電機版本切換時保留原有填報資料
- 🔗 **快速導航**：從用戶列表直接跳轉到用戶詳情頁面

### 2. 動態側邊欄系統

#### 2.1 用戶端體驗
**需求**:
- 用戶登入後側邊欄**只顯示**被指定的能源類別
- 未指定類別**完全不顯示**（不是灰色禁用）
- 動態生成導航選單

**實現邏輯**:
```typescript
// 根據 filling_config.visible_categories 過濾側邊欄項目
const visibleCategories = user.filling_config?.visible_categories || []
const sidebarItems = allCategories.filter(cat => visibleCategories.includes(cat.pageKey))
```

#### 2.2 年份提醒
**需求**:
- 在填報頁面顯示目標年份提醒
- 不強制限制，僅作為指引

### 3. 審核工作流優化

#### 3.1 批量審核功能
**當前狀態**: 基本審核功能  
**目標狀態**: 高效批量處理

**功能增強**:
- 📋 **批量選擇**：支援多選填報記錄
- ✅ **批量通過**：一鍵批准多筆記錄
- ❌ **批量退回**：統一退回並註明原因
- 🔍 **狀態篩選**：依據審核狀態快速篩選

#### 3.2 退回管理
**需求**:
- **整筆退回**：退回整個能源類別的記錄（不是單月）
- **原因註記**：使用 `energy_entries.review_notes` 欄位
- **用戶通知**：在填報頁面顯示退回原因
- **重新提交**：用戶修正後可重新提交

### 4. 用戶狀態管理

#### 4.1 啟用/停用功能
**需求**:
- 管理員可啟用/停用用戶帳戶
- 停用用戶無法登入系統
- 使用現有 `profiles.is_active` 欄位

---

## 🎨 UI/UX 設計要求

### 1. 視覺設計風格

#### 1.1 設計語言
- **現代化卡片式佈局**：清晰的內容區塊劃分
- **一致的間距系統**：使用 Tailwind CSS spacing scale
- **統一色彩系統**：
  - 主色調：藍色系 (專業、可信賴)
  - 輔助色：綠色 (通過)、紅色 (錯誤)、橙色 (警告)
- **簡潔的圖標系統**：使用 Emoji 符號確保跨平台兼容

#### 1.2 佈局原則
- **響應式設計**：桌面優先，平板適配
- **資訊層級**：重要資訊突出顯示
- **操作便利性**：常用功能易於存取

### 2. 頁面結構設計

#### 2.1 主控台 (AdminDashboard) ✅ 已設計
**設計要點**：
```
┌─────────────────────────────────────────────────────┐
│ 📊 系統概覽卡片區（4個統計卡片，一行排列）                    │
│ [提交數量] [待審核] [已通過] [已退回]                        │
├─────────────────────────────────────────────────────┤
│ 📋 用戶管理區域                                          │
│ 搜尋與篩選 + [新增用戶]                                   │
│ 用戶卡片列表（含快速導航按鈕）                              │
└─────────────────────────────────────────────────────┘
```

**統計卡片功能**：
- 可點擊跳轉到對應的填報管理頁面
- 簡潔設計：圖標 + 標題 + 數字
- 選中狀態有藍色邊框高亮

#### 2.2 建立用戶頁面 ✅ 已設計
**表單設計**：
```
基本資料區塊
├── 姓名、Email、密碼（必填）
├── 公司、職位、電話（選填）
└── 用戶角色選擇

填報設定區塊  
├── 目標年份（輸入框，如：2024）
├── 可見類別多選器（14個類別，按範疇分組）
│   ├── 範疇一（12項，有全選按鈕）
│   ├── 範疇二（1項）
│   └── 範疇三（1項）
└── 柴油發電機版本（加油版/測試版）

提交區塊
├── [取消] [建立用戶]
└── 驗證：至少選一個類別、密碼確認
```

#### 2.3 編輯用戶頁面 ✅ 已設計
**佈局設計**：
```
主要內容區（左側）
├── 基本資料編輯表單
├── 填報設定編輯（預填現有資料）
└── [取消變更] [儲存變更]

側邊欄區（右側）
├── 快速操作（查看填報、查看審核、重設密碼）
├── 用戶統計（註冊時間、登入記錄、填報進度）
└── 帳戶狀態（狀態、角色、目標年份）

頂部操作
├── [返回用戶管理]
└── [停用/啟用用戶]
```

#### 2.4 填報管理頁面 ✅ 已設計
**核心功能**：
```
狀態選擇區（頂部）
├── [已提交] [待審核] [已通過] [已退回]  # 4個卡片一行排列
├── 點擊切換顯示對應狀態的記錄
└── 選中狀態有視覺回饋

篩選區域
├── 用戶篩選、能源類別篩選
├── 排序方式（最新提交在前/最早提交在前）
└── 結果摘要顯示

記錄列表
├── 列表式設計（無滑軸）
├── 每行包含：用戶+類別、公司+年度、狀態標籤、詳細資訊
├── 點擊整行 → 進入現有的用戶填寫介面進行審核
└── 分頁處理大量資料
```

### 3. 關鍵交互設計

#### 3.1 狀態管理
- **4種審核狀態**：已提交（藍）、待審核（橘）、已通過（綠）、已退回（紅）
- **狀態切換**：點擊狀態卡片，列表內容動態更新
- **用戶狀態**：啟用/停用一鍵切換

#### 3.2 快速導航
每個用戶卡片提供4個操作按鈕：
- **📄 查看填報** → 該用戶的所有填報記錄
- **👁️ 查看審核** → 該用戶的審核狀況  
- **✏️ 編輯用戶** → 修改用戶基本資料和設定
- **❌ 停用/✅ 啟用** → 直接切換用戶狀態

#### 3.3 類別管理
- **動態側邊欄**：用戶只看到被指定的類別
- **可見類別設定**：管理員可為每個用戶選擇14個類別中的任意組合
- **範疇分組顯示**：範疇一（12項）、範疇二（1項）、範疇三（1項）

#### 3.4 審核工作流
- **列表篩選**：按狀態、用戶、類別篩選記錄
- **時間排序**：最新/最早提交排序
- **點擊審核**：點擊記錄 → 進入現有用戶填寫介面 → 管理員可進行審核操作

---

## 🔧 技術實現規劃

### 1. 資料庫變更

#### 1.1 保持現有結構
- ✅ `profiles` 表結構保持不變
- ✅ `energy_entries` 表結構保持不變
- ✅ 所有現有 API 接口保持不變

#### 1.2 擴展 filling_config
```sql
-- 範例用戶配置
UPDATE profiles SET filling_config = '{
  "diesel_generator_mode": "refuel",
  "visible_categories": ["wd40", "acetylene", "natural_gas", "electricity_bill"],
  "target_year": 2024
}'::jsonb WHERE id = 'user-id';
```

### 2. 前端實現策略

#### 2.1 漸進式重構
- **階段1**: 重構主控台佈局和視覺設計
- **階段2**: 實現增強用戶管理功能
- **階段3**: 優化審核工作流
- **階段4**: 完善動態側邊欄系統

#### 2.2 元件架構
```typescript
// 新的管理員元件架構
AdminDashboard
├── DashboardHeader (系統概覽)
├── QuickActions (快速操作)
├── TabNavigation (功能導航)
└── TabContent
    ├── UserManagement
    │   ├── UserList
    │   ├── CreateUserForm (增強版)
    │   └── EditUserForm (增強版)
    ├── ReviewWorkbench
    │   ├── PendingReviews
    │   ├── BatchActions
    │   └── ReviewHistory
    └── DataOverview
        ├── StatisticsCards
        └── ExportTools
```

### 3. API 擴展需求

#### 3.1 新增 API 端點
```typescript
// 用戶配置管理
updateUserConfig(userId: string, config: FillingConfig): Promise<void>
switchDieselGeneratorMode(userId: string, mode: 'refuel'|'test'): Promise<void>

// 批量審核
batchApproveEntries(entryIds: string[]): Promise<void>
batchRejectEntries(entryIds: string[], reason: string): Promise<void>

// 動態側邊欄
getUserVisibleCategories(userId: string): Promise<CategoryItem[]>
```

#### 3.2 保持現有 API
- 所有現有的 `adminUsers.ts` API 保持不變
- 所有現有的 `adminSubmissions.ts` API 保持不變
- 僅新增功能，不修改現有接口

---

## 📋 開發檢查清單

### Phase 1: 主控台重構 (Week 1)
- [x] ✅ 設計4個統計卡片佈局（提交、待審核、已通過、已退回）
- [x] ✅ 統計卡片點擊跳轉功能
- [x] ✅ 用戶管理區域重新設計
- [x] ✅ 移除快速操作區（簡化設計）
- [x] ✅ 統一色彩和間距系統

### Phase 2: 用戶管理增強 (Week 2)
- [x] ✅ 建立用戶表單重構（新增類別選擇、年份設定、柴油發電機版本）
- [x] ✅ 編輯用戶頁面設計（主輔佈局 + 側邊欄）
- [x] ✅ 用戶配置 API 端點規劃
- [x] ✅ 快速導航按鈕設計（查看填報、查看審核、編輯、停用）

### Phase 3: 填報管理系統 (Week 3)
- [x] ✅ 狀態篩選卡片設計（4個一行排列）
- [x] ✅ 列表式記錄顯示（無滑軸）
- [x] ✅ 篩選功能優化（用戶、類別、排序）
- [x] ✅ 點擊記錄跳轉到用戶填寫介面

### Phase 4: 動態側邊欄系統 (Week 4)
- [ ] 實現 getUserVisibleCategories API
- [ ] 修改 Sidebar 元件支援動態過濾
- [ ] 實現年份提醒系統
- [ ] 測試不同用戶配置的側邊欄顯示

### Phase 5: 整合測試與優化 (Week 5)
- [ ] 跨瀏覽器測試
- [ ] 響應式設計測試
- [ ] 效能優化
- [ ] 用戶體驗優化

---

## 🎯 成功標準

### 功能完整性
- ✅ 所有現有功能正常運作
- ✅ 新增功能符合需求規格
- ✅ API 接口保持向後兼容

### 使用者體驗
- ✅ 介面操作直觀易懂
- ✅ 視覺設計統一美觀
- ✅ 響應速度流暢

### 技術品質
- ✅ TypeScript 類型安全
- ✅ 元件可重用性高
- ✅ 程式碼結構清晰

### 效能指標
- ✅ 頁面載入時間 < 2秒
- ✅ API 響應時間 < 500ms
- ✅ 無記憶體洩漏問題

---

## 🚀 實施計畫

### 開發週期：5週
### 資源需求：1名前端開發者
### 關鍵里程碑：
- Week 1: 完成主佈局重構
- Week 2: 完成用戶管理增強
- Week 3: 完成動態側邊欄
- Week 4: 完成審核工作流
- Week 5: 測試與上線

---

## 📝 風險評估

### 技術風險
- **風險**: 資料庫結構變更可能影響現有功能
- **應對**: 僅擴展 JSONB 欄位，不修改既有結構

### 時程風險  
- **風險**: 功能複雜度可能導致延期
- **應對**: 採用漸進式開發，優先實現核心功能

### 用戶接受度風險
- **風險**: 介面變更可能影響用戶使用習慣
- **應對**: 保持操作邏輯一致，提供使用指引

---

**PRD 狀態**: ✅ 已完成，待開發團隊確認